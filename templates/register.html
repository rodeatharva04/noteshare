{% extends 'base.html' %}

{% block content %}
<style>
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px var(--surface-input) inset !important;
        -webkit-text-fill-color: var(--text-main) !important;
        caret-color: var(--text-main);
        transition: background-color 5000s ease-in-out 0s;
    }
</style>

<div class="container d-flex justify-content-center align-items-center py-5" style="min-height: 90vh;">
    <div class="card-modern" style="max-width: 550px; width: 100%;">

        <div class="card-header-modern bg-gradient-success">
            <div class="mb-2">
                <i class="fas fa-user-plus fa-3x text-white opacity-75"></i>
            </div>
            <h3 class="fw-bold mb-0 text-white">Join NoteShare</h3>
            <p class="small text-white-50 mb-0">Create your account to start sharing.</p>
        </div>

        <div class="card-body p-4 p-md-5">
            <form method="post" enctype="multipart/form-data" novalidate id="registerForm">
                {% csrf_token %}

                {% if u_form.non_field_errors %}
                <div class="alert alert-danger py-2 small shadow-sm mb-4 border-0">
                    {% for error in u_form.non_field_errors %}
                    <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="d-flex align-items-center mb-4 pb-2" style="border-bottom: 1px solid var(--border-color);">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 bg-gradient-success" style="width: 30px; height: 30px; --bs-bg-opacity: .2;">
                        <i class="fas fa-shield-alt text-white small"></i>
                    </div>
                    <h6 class="text-uppercase text-white opacity-75 fw-bold mb-0" style="letter-spacing: 1px; font-size: 0.8rem;">Account Info</h6>
                </div>

                {% for field in u_form %}
                <div class="mb-3">
                    <label class="small text-white opacity-75 text-uppercase fw-bold mb-1">
                        {{ field.label }}
                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>

                    <div class="input-group">
                        <span class="input-group-text" style="border-color: var(--border-color);">
                            {% if 'username' in field.name %} <i class="fas fa-at text-success"></i>
                            {% elif 'email' in field.name %} <i class="fas fa-envelope text-success"></i>
                            {% elif 'pass' in field.name %} <i class="fas fa-lock text-success"></i>
                            {% else %} <i class="fas fa-user text-success"></i>
                            {% endif %}
                        </span>

                        <input type="{{ field.field.widget.input_type }}" name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-control {% if field.errors %}is-invalid{% endif %}" placeholder="Enter {{ field.label|lower }}" {% if field.value %}value="{{ field.value }}"{% endif %}>
                    </div>

                    {% if field.errors %}
                    <div class="text-danger small mt-1 fw-bold">
                        {% for error in field.errors %}
                        <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                <div class="d-flex align-items-center mb-4 mt-5 pb-2" style="border-bottom: 1px solid var(--border-color);">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; background: var(--brand-accent);">
                        <i class="fas fa-id-card text-dark small"></i>
                    </div>
                    <h6 class="text-uppercase text-white opacity-75 fw-bold mb-0" style="letter-spacing: 1px; font-size: 0.8rem;">Profile Details</h6>
                </div>

                <div class="mb-3">
                    <label class="small text-white opacity-75 text-uppercase fw-bold mb-1">Bio (Optional)</label>
                    <div class="input-group">
                        <span class="input-group-text" style="border-color: var(--border-color);">
                            <i class="fas fa-pen" style="color: var(--brand-accent);"></i>
                        </span>
                        <textarea name="bio" class="form-control" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="small text-white opacity-75 text-uppercase fw-bold mb-1">Profile Picture</label>
                    <div class="input-group">
                        <input type="file" name="profile_pic" class="form-control" id="id_profile_pic" accept="image/*">
                        <span class="input-group-text" style="border-color: var(--border-color);">
                            <i class="fas fa-camera text-white opacity-50"></i>
                        </span>
                    </div>
                    <div class="form-text text-white-50 small">Max size: 5MB. Formats: JPG, PNG.</div>
                </div>

                <div class="d-grid mt-5">
                    <button type="submit" id="registerBtn" class="btn-brand shadow-lg fw-bold" style="background: var(--grad-success) !important;">
                        CREATE ACCOUNT
                    </button>
                </div>
            </form>
        </div>

        <div class="card-footer bg-transparent py-4 text-center" style="border-top: 1px solid var(--border-color);">
            <p class="small text-white opacity-75 mb-0">
                Already have an account?
                <a href="{% url 'login' %}" class="fw-bold text-decoration-none hover-warning" style="color: var(--color-success);">Login here</a>
            </p>
        </div>
    </div>
</div>

<script>
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const btn = document.getElementById('registerBtn');
        const originalText = btn.innerText;

        const username = this.querySelector('input[name="username"]').value;
        const first_name = this.querySelector('input[name="first_name"]').value;
        const last_name = this.querySelector('input[name="last_name"]').value;

        const fileInput = document.getElementById('id_profile_pic');

        if (username.length > 15) {
            showToast("Username too long (Max 15 chars).", "error");
            return;
        }
        if (first_name.length > 20) {
            showToast("First name too long (Max 20 chars).", "error");
            return;
        }
        if (last_name.length > 20) {
            showToast("Last name too long (Max 20 chars).", "error");
            return;
        }

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const maxSize = 5 * 1024 * 1024;

            if (file.size > maxSize) {
                if (typeof showToast === "function") {
                    showToast("Profile image too large! Max size is 5MB.", "error");
                } else {
                    alert("Profile image too large! Max size is 5MB.");
                }
                return;
            }

            if (!file.type.startsWith('image/')) {
                if (typeof showToast === "function") {
                    showToast("Invalid file. Please upload an image.", "error");
                } else {
                    alert("Invalid file. Please upload an image.");
                }
                return;
            }
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i> Creating Account...';

        try {
            const res = await fetch("{% url 'register' %}", {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await res.json();

            if (data.status === 'success') {
                showToast('Account created! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1000);
            } else if (data.status === 'error') {
                let errorMsg = "Please fix the errors.";

                const keys = Object.keys(data.errors);
                if (keys.length > 0) {
                    const firstField = keys[0];
                    const firstError = data.errors[firstField][0];
                    errorMsg = `${firstField.toUpperCase()}: ${firstError}`;
                }

                showToast(errorMsg, 'error');

                btn.disabled = false;
                btn.innerText = originalText;
            } else {
                window.location.reload();
            }

        } catch (err) {
            console.error(err);
            showToast('Connection error. Please try again.', 'error');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    });
</script>
{% endblock %}

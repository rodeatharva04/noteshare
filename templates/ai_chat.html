{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  mjx-container {
    overflow-x: auto !important;
    overflow-y: hidden;
    max-width: 100%;
    display: block !important;
    padding-bottom: 8px;
  }

  mjx-container::-webkit-scrollbar {
    height: 6px;
    background: transparent;
  }

  mjx-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
  }

  mjx-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 10px;
  }

  mjx-container::-webkit-scrollbar-thumb:hover {
    background: var(--brand-primary);
  }

  :root {
    --study-bg: #0f0f12;
    --study-surface: #1e1e1e;
    --study-border: #333333;
    --study-text: #e0e0e0;
  }

  nav.navbar,
  footer {
    display: none !important;
  }

  .container,
  .container-fluid,
  body,
  html {
    padding: 0 !important;
    margin: 0 !important;
    max-width: 100% !important;
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    background-color: var(--study-bg) !important;
    color: var(--study-text) !important;
  }

  .study-container {
    display: flex;
    flex-direction: column;
    width: 100vw;
    height: 100vh;
    background-color: var(--study-bg);
  }

  .viewer-pane {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--study-border);
    background: radial-gradient(circle at center, #1f2023 0%, #0f0f12 100%);
    position: relative;
  }

  .viewer-header {
    height: 60px;
    flex-shrink: 0;
    background: rgba(26, 27, 30, 0.95);
    border-bottom: 1px solid var(--study-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
  }

  .viewer-body {
    flex: 1;
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
    background-color: #000;
  }

  .paper-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background-color: white;
  }

  .dark-glass-viewer {
    width: 100%;
    height: 100%;
    background: rgba(20, 20, 20, 0.6);
    backdrop-filter: blur(12px);
    display: flex;
    flex-direction: column;
  }

  .dark-glass-viewer pre {
    margin: 0;
    height: 100%;
    overflow: auto;
    padding: 0;
  }

  .dark-glass-viewer code {
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
    line-height: 1.6;
    background: transparent !important;
    min-height: 100%;
  }

  .resizer {
    background: var(--study-bg);
    border: 1px solid var(--study-border);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    z-index: 100;
    transition: background 0.2s;
  }

  .resizer:hover,
  .resizer.active {
    background: #667eea;
  }

  .grip-lines {
    width: 4px;
    height: 30px;
    background: #444;
    border-radius: 2px;
  }

  .chat-pane {
    display: flex;
    flex-direction: column;
    background-color: #161616;
    overflow: hidden;
  }

  .chat-header {
    height: 60px;
    flex-shrink: 0;
    background: var(--study-surface);
    border-bottom: 1px solid var(--study-border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 10px;
  }

  .chat-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .chat-input-box {
    padding: 20px;
    background: var(--study-surface);
    border-top: 1px solid var(--study-border);
    flex-shrink: 0;
  }

  .msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: white;
    overflow-wrap: anywhere;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .msg ul,
  .msg ol {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
  }

  .msg li {
    margin-bottom: 0.5rem;
  }

  .msg.user {
    align-self: flex-end;
    background: var(--grad-primary);
    border-bottom-right-radius: 4px;
  }

  .msg.ai {
    align-self: flex-start;
    background: var(--surface-input);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
  }

  .msg.ai code {
    color: #ff9e9e;
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 5px;
    border-radius: 4px;
  }

  .msg.ai pre {
    background: #000;
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
    margin-top: 10px;
    border: 1px solid #444;
  }

  .typing {
    display: none;
    align-self: flex-start;
    margin-left: 10px;
  }

  .dot {
    width: 6px;
    height: 6px;
    background: #888;
    border-radius: 50%;
    display: inline-block;
    animation: bounce 1.4s infinite;
    margin: 0 2px;
  }

  .dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-4px);
    }
  }

  @media (min-width: 769px) {
    .study-container {
      flex-direction: row;
    }

    .viewer-pane {
      width: 60%;
      min-width: 300px;
      height: 100% !important;
    }

    .chat-pane {
      flex: 1;
      min-width: 300px;
      height: 100% !important;
    }

    .resizer {
      width: 12px;
      height: 100%;
      cursor: col-resize;
      border-top: none;
      border-bottom: none;
    }
  }

  @media (max-width: 768px) {
    .study-container {
      flex-direction: column;
    }

    .viewer-pane {
      width: 100% !important;
      height: 45%;
      flex: none;
      border-right: none;
      border-bottom: 1px solid var(--study-border);
    }

    .chat-pane {
      width: 100% !important;
      height: auto;
      flex: 1;
    }

    .resizer {
      width: 100%;
      height: 24px;
      cursor: row-resize;
      border-left: none;
      border-right: none;
      background: var(--study-surface);
    }

    .grip-lines {
      width: 40px;
      height: 4px;
    }
  }
</style>

<div class="study-container" id="mainContainer">
  <div class="viewer-pane" id="viewerPane">
    <div class="viewer-header">
      <div class="text-truncate fw-bold d-flex align-items-center gap-2" style="max-width: 50%; color: #fff !important;">
        <i class="fas fa-file-alt text-primary"></i>
        <span class="text-truncate">{{ note.title }}</span>
        <span class="badge bg-dark border border-secondary text-muted" style="font-size: 0.7em;">
          {{ note.get_file_type|upper }}
        </span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a href="{{ note.file.url }}" target="_blank" class="btn btn-sm text-white d-flex align-items-center gap-2 px-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; height: 34px;" title="Open Native">
          <i class="fas fa-external-link-alt small"></i>
          <span class="d-none d-md-inline small">Open</span>
        </a>

        <a href="{{ note.file.url }}" download class="btn btn-sm btn-brand d-flex align-items-center gap-2 px-3 shadow-sm" style="border-radius: 50px; height: 34px; border: none;" title="Save to Device">
          <i class="fas fa-download small"></i>
          <span class="d-none d-md-inline small">Download</span>
        </a>

        <a href="{% url 'note_detail' note.pk %}" onclick="event.preventDefault(); window.history.back();" class="btn btn-sm btn-outline-danger rounded-pill px-3 d-flex align-items-center gap-2" title="Exit Study Mode">
          <i class="fas fa-sign-out-alt"></i>
          <span class="d-none d-md-inline small">Exit</span>
        </a>
      </div>
    </div>

    <div class="viewer-body">
      {% with ftype=note.get_file_type %}
      {% if ftype == 'pdf' %}
      <iframe src="{{ note.file.url }}" class="paper-iframe"></iframe>
      {% elif ftype == 'office' %}
      <iframe src="https://docs.google.com/viewer?url={{ request.scheme }}://{{ request.get_host }}{{ note.file.url }}&embedded=true" class="paper-iframe"></iframe>
      {% elif ftype == 'code' %}
      <div class="dark-glass-viewer">
        <div class="px-3 py-2 d-flex justify-content-between align-items-center" style="background: rgba(255,255,255,0.05); height: 40px;">
          <span class="small text-white opacity-75 font-monospace">{{ note.file.name }}</span>
          <i class="fas fa-code text-warning"></i>
        </div>
        <div style="flex: 1; overflow: hidden;">
          <pre><code id="codeBlock" class="language-plaintext">Loading content...</code></pre>
        </div>
      </div>
      <script>
        fetch("{{ note.file.url }}").then(r => r.text()).then(text => {
          const b = document.getElementById('codeBlock');
          b.textContent = text;
          let ext = "{{ note.file.name }}".split('.').pop().toLowerCase();
          b.className = (ext === 'csv') ? 'language-plaintext' : `language-${ext}`;
          hljs.highlightElement(b);
        });
      </script>
      {% elif ftype == 'image' %}
      <a href="{{ note.file.url }}" target="_blank" title="Click to Zoom"><img src="{{ note.file.url }}" style="max-width: 100%; max-height: 100%; object-fit: contain;"></a>
      {% elif ftype == 'video' %}
      <video controls style="width: 100%; max-height: 100%;">
        <source src="{{ note.file.url }}">
      </video>
      {% elif ftype == 'audio' %}
      <div class="p-5 text-center">
        <i class="fas fa-music fa-3x text-primary mb-3"></i>
        <h5 class="text-white">{{ note.title }}</h5>
        <audio controls style="width: 300px; margin-top: 20px;">
          <source src="{{ note.file.url }}">
        </audio>
      </div>
      {% else %}
      <div class="text-center text-muted">
        <i class="fas fa-file-archive fa-3x mb-3 opacity-50"></i>
        <h5>Preview Unavailable</h5>
        <a href="{{ note.file.url }}" class="btn btn-brand mt-2">Download File</a>
      </div>
      {% endif %}
      {% endwith %}
    </div>
  </div>

  <div class="resizer" id="dragHandle">
    <div class="grip-lines"></div>
  </div>

  <div class="chat-pane" id="chatPane">
    <div class="chat-header">
      <div class="d-flex align-items-center gap-3">
        <i class="fas fa-robot text-info fa-lg"></i>
        <div>
          <strong class="d-block text-white" style="line-height: 1.2;">Gemini AI</strong>
          <small class="text-success fw-bold" style="font-size: 0.75rem;"><i class="fas fa-circle" style="font-size: 6px; vertical-align: middle;"></i> ONLINE</small>
        </div>
      </div>
    </div>

    <div class="chat-scroll" id="chatBox">
      <div class="msg ai">
        Hello! I am ready to study <strong>{{ note.title }}</strong> with you. Ask me anything!
      </div>
      <div class="typing" id="typingIndicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>

    <div class="chat-input-box">
      <form id="chatForm" class="d-flex gap-2 align-items-end">
        {% if note.file.size < 1048576 %}
        <button type="button" id="fileToggleBtn" class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 42px; height: 42px; transition: all 0.3s;" title="Include full file content in AI context">
          <i class="fas fa-file-alt"></i>
        </button>
        {% endif %}
        <input type="text" id="userInput" class="form-control rounded-pill" placeholder="Ask a question..." autocomplete="off" style="height: 42px;">
        <button type="submit" id="sendBtn" class="btn btn-brand rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 42px; height: 42px;">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const resizer = document.getElementById('dragHandle');
  const leftPane = document.getElementById('viewerPane');
  let isResizing = false;

  resizer.addEventListener('mousedown', startResize);
  resizer.addEventListener('touchstart', startResize, {
    passive: false
  });

  function startResize(e) {
    e.preventDefault();
    isResizing = true;
    resizer.classList.add('active');
    document.querySelectorAll('iframe').forEach(i => i.style.pointerEvents = 'none');
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('touchmove', handleResize, {
      passive: false
    });
    document.addEventListener('mouseup', stopResize);
    document.addEventListener('touchend', stopResize);
  }

  function handleResize(e) {
    if (!isResizing) return;
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
      const heightPercent = (clientY / window.innerHeight) * 100;
      if (heightPercent > 20 && heightPercent < 80) leftPane.style.height = heightPercent + "%";
    } else {
      const widthPercent = (clientX / window.innerWidth) * 100;
      if (widthPercent > 20 && widthPercent < 80) leftPane.style.width = widthPercent + "%";
    }
  }

  function stopResize() {
    isResizing = false;
    resizer.classList.remove('active');
    document.querySelectorAll('iframe').forEach(i => i.style.pointerEvents = 'auto');
    document.removeEventListener('mousemove', handleResize);
    document.removeEventListener('touchmove', handleResize);
    document.removeEventListener('mouseup', stopResize);
    document.removeEventListener('touchend', stopResize);
  }

  const chatBox = document.getElementById('chatBox');
  const chatForm = document.getElementById('chatForm');
  const userInput = document.getElementById('userInput');
  const typingIndicator = document.getElementById('typingIndicator');
  const sendBtn = document.getElementById('sendBtn');
  const fileToggleBtn = document.getElementById('fileToggleBtn');
  let useFile = false;

  if (fileToggleBtn) {
    fileToggleBtn.addEventListener('click', () => {
      useFile = !useFile;
      if (useFile) {
        fileToggleBtn.classList.remove('btn-outline-secondary');
        fileToggleBtn.classList.add('btn-success');
        fileToggleBtn.style.boxShadow = "0 0 10px rgba(25, 135, 84, 0.4)";
      } else {
        fileToggleBtn.classList.remove('btn-success');
        fileToggleBtn.classList.add('btn-outline-secondary');
        fileToggleBtn.style.boxShadow = "none";
      }
    });
  }

  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const text = userInput.value.trim();
    if (!text) return;

    addMsg(text, 'user');
    userInput.value = '';
    sendBtn.disabled = true;
    typingIndicator.style.display = 'block';
    chatBox.appendChild(typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
      const res = await fetch("{% url 'ai_chat_api' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          message: text,
          note_id: "{{ note.pk }}",
          use_file: useFile
        })
      });
      const data = await res.json();

      typingIndicator.style.display = 'none';
      if (data.response) {
        addMsg(DOMPurify.sanitize(marked.parse(data.response)), 'ai', true);
      } else {
        addMsg("Error: " + (data.error || "Unknown response"), 'ai');
      }
    } catch (error) {
      typingIndicator.style.display = 'none';
      addMsg("Network Error: Could not reach Gemini.", 'ai');
      console.error(error);
    } finally {
      sendBtn.disabled = false;
    }
  });

  function addMsg(content, sender, isHtml = false) {
    const div = document.createElement('div');
    div.className = 'msg ' + sender;
    if (isHtml) div.innerHTML = content;
    else div.textContent = content;

    chatBox.insertBefore(div, typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;

    if (sender === 'ai') {
      if (window.MathJax) {
        MathJax.typesetPromise([div]).then(() => {
          chatBox.scrollTop = chatBox.scrollHeight;
        });
      }
      div.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    }
  }
</script>
{% endblock %}
